<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="phonemeConverter.js"></script>

    <script src="utils.js"></script>
    <script src="text-to-ipa.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoneme to Viseme Lipsync Mapper</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .output-section {
            margin-top: 30px;
        }

        .output-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .viseme-display {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .viseme-item {
            background: #e3f2fd;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
            color: #1976d2;
            font-size: 14px;
        }

        .timing-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 13px;
        }

        .legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .legend h3 {
            margin-top: 0;
            color: #333;
        }

        .legend-item {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó£Ô∏è Phoneme to Viseme Lipsync Mapper</h1>

        <div class="input-section">
            <label for="textInput">Text to Convert:</label>
            <textarea id="textInput"
                placeholder="Enter the text you want to convert to lipsync animation...">The New York Times is an American daily newspaper based in New York City. The New York Times covers domestic, national, and international news, and publishes opinion pieces, investigative reports, and reviews.</textarea>
        </div>

        <div class="input-section">
            <label for="speechRate">Speech Rate:</label>
            <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1">
            <span id="speechRateValue">1.0</span>
        </div>

        <div class="controls">
            <button id="generateLipsyncBtn">Generate Lipsync Data</button>
            <button id="testSpeechBtn">Test Speech + Animation</button>
            <button id="stopSpeechBtn" disabled>Stop Speech</button>
        </div>



    </div>

    <script type="module">

        const phonemeDurations = {
            'vowels': 90,
            'consonants': 45,
            'silence': 40
        };


        function addFunctionality() {
            document.getElementById('generateLipsyncBtn').addEventListener('click', generateLipsync);
            document.getElementById('testSpeechBtn').addEventListener('click', testSpeechWithAnimation);
            document.getElementById('stopSpeechBtn').addEventListener('click', stopSpeech);
        }

        // Basic English phoneme to viseme mapping


        const availableVisemes = ["A", "O", "E", "I", "U", "M", "F", "TH", "L", "S", "SH", "REST", "R", "W"]

        // Helper function to categorize phonemes for duration calculation


        let currentUtterance = null;
        let animationData = null;
        let currentVisemeIndex = 0;
        let currentWord = null;
        let wordToVisemeMap = [];
        let isAnimating = false;

        function updateSpeechRateDisplay() {
            document.getElementById('speechRateValue').textContent = document.getElementById('speechRate').value;
        }



        function createWordToVisemeMapping(text) {
            const words = text.toLowerCase().split(/\s+/);
            const mapping = {}
            let charIndex = 0;


            for (let word of words) {
                const wordWithoutPunctuation = word.replace(/[^\w\s]/g, '').toLowerCase()

                mapping[charIndex] = {
                    word: word,
                    phonemes: convertWordToPhonemes(wordWithoutPunctuation),
                    visemes: [],
                    durations: []
                }


                mapping[charIndex].phonemes.forEach(phoneme => {
                    const viseme = convertPhonemesToVisemes(phoneme) || 'REST'
                    mapping[charIndex].visemes.push(viseme);
                    mapping[charIndex].durations.push(getPhonemeDuration(phoneme));
                });







                charIndex += word.length + 1; // +1 for space
            }

            return mapping;
        }
        window.createWordToVisemeMapping = createWordToVisemeMapping


        function removeConsecutiveDuplicates(arr) {
            if (!arr || arr.length === 0) {
                return [];
            }
            const result = [arr[0]];
            for (let i = 1; i < arr.length; i++) {
                if (arr[i] !== arr[i - 1]) {
                    result.push(arr[i]);
                }
            }
            return result;
        }
        function generateLipsync() {
            const text = document.getElementById('textInput').value;
            const speechRate = parseFloat(document.getElementById('speechRate').value);

            if (!text.trim()) {
                alert('Please enter some text to convert.');
                return;
            }

            wordToVisemeMap = createWordToVisemeMapping(text);





        }










        function testSpeechWithAnimation() {
            const text = document.getElementById('textInput').value;
            const speechRate = parseFloat(document.getElementById('speechRate').value);

            if (!text.trim()) {
                alert('Please enter some text to speak.');
                return;
            }

            // Make sure we have generated the lipsync data
            if (!wordToVisemeMap.length) {
                generateLipsync();
            }

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.rate = speechRate;
            currentUtterance.lang = "en-US";






            window.currentUtterance = currentUtterance

            currentVisemeIndex = 0;
            isAnimating = true;

            currentUtterance.onstart = () => {
                document.getElementById('testSpeechBtn').disabled = true;
                document.getElementById('stopSpeechBtn').disabled = false;
                console.log('Speech and animation started');
            };



            currentUtterance.onboundary = (event) => {


                if (event.name === 'word') {
                    animateWordInMouth(wordToVisemeMap[event.charIndex])
                } else {
                    animateWordInMouth(null)
                }



            };

            currentUtterance.onend = () => {
                document.getElementById('testSpeechBtn').disabled = false;
                document.getElementById('stopSpeechBtn').disabled = true;
                isAnimating = false;

                console.log('Speech and animation ended');
            };


            console.log('Current utterance:', currentUtterance);

            speechSynthesis.speak(currentUtterance);
        }



        function stopSpeech() {
            if (currentUtterance) {
                speechSynthesis.cancel();
                document.getElementById('testSpeechBtn').disabled = false;
                document.getElementById('stopSpeechBtn').disabled = true;
            }
        }

        // Initialize  
        function init() {
            TextToIPA.loadDict("ipadict.txt", () => {
                console.log("loaded")

                // Initialize functionality after data is loaded
                addFunctionality();

                // Generate initial example
                generateLipsync();
            })
            document.getElementById('speechRate').addEventListener('input', updateSpeechRateDisplay);
            updateSpeechRateDisplay();

        }
        init()

    </script>



    <script>
        // Phaser game configuration
        const config = {
            type: Phaser.AUTO,
            width: 400,
            height: 400,
            parent: 'phaser-game',
            backgroundColor: '#34495e',
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };
        let mouthSprite;
        let scene;

        function preload() {
            scene = this;

            // Load all mouth textures
            const visemes = ['a', 'e', 'f', 'l', 'm', 'o', 'r', 's', 'sh', 'th', 'u', "rest"];

            visemes.forEach(viseme => {
                this.load.image(`mouth_${viseme}`, `./mouths/${viseme}.png`);
            });


        }

        function create() {
            mouthSprite = this.add.sprite(200, 200, 'mouth_rest');

        }
        function updateMouth(viseme) {
            // Convert viseme to lowercase to match our texture names
            const visemeKey = viseme.toLowerCase();

            // Check if the texture exists before setting it


            mouthSprite.setTexture(`mouth_${visemeKey}`);

        }

        function update() {

        }
        let arrOfTimeOuts = []

        function animateWordInMouth(word) {

            let currentVisemeIndex = 0;

            for (let i = 0; i < arrOfTimeOuts.length; i++) {
                clearTimeout(arrOfTimeOuts[i])
            }
            arrOfTimeOuts = []
            console.log(word)

            if (!word) {
                updateMouth("rest")
                return
            }


            let totalDuration = word.durations[0]

            updateMouth(word.visemes[0])
            for (let i = 1; i < word.visemes.length; i++) {

                const timeoutObj = setTimeout(() => {
                    updateMouth(word.visemes[i])
                }, totalDuration)

                arrOfTimeOuts.push(timeoutObj)
                totalDuration += word.durations[i] / currentUtterance.rate
            }
            setTimeout(() => {
                updateMouth("rest")
            }, totalDuration)


            /*
            durations: Array [ 80, 120 ]
‚Äã
            phonemes: Array [ "DH", "AH" ]
            ‚Äã
            visemes: Array [ "TH", "A" ]
            ‚Äã
            word: "the"
            */




        }

        const game = new Phaser.Game(config);

    </script>
</body>
</html>